{% extends "base.html" %}
{% load static %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/courses-detail.css' %}">
{% endblock css %}

{% block main %}
<div class="course-detail-page">

  <!-- Sidebar Left -->
  <div class="course-sidebar">
    <h2>{{ course.title }}</h2>

    {% for section, videos in videos_by_section.items %}
    <div class="course-section">
      <h3>{{ section }}</h3>
      <ul class="video-list">
        {% for video in videos %}
        <li class="video-item {% if forloop.first and forloop.parentloop.first %}active{% endif %}" data-video-url="{{ video.video_file.url }}">
          <span class="checkbox {% if forloop.first and forloop.parentloop.first %}checked{% endif %}"></span>
          <span class="video-icon">üìπ</span>
          <span class="video-title">{{ forloop.counter }}. {{ video.title }}</span>
          <span class="video-time">{{ video.duration }}</span>
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endfor %}
  </div>

  <!-- Main Video Area Right -->
  <div class="video-area">
    <video id="videoPlayer" controls playsinline>
{% if course.videos.all %}
  <source src="{{ course.videos.all.0.video_file.url }}" type="video/mp4">
{% endif %}
      Your browser does not support the video tag.
    </video>
    <button id="nextVideoBtn">Complete and Continue ‚û°Ô∏è</button>
  </div>

</div>
{% endblock main %}

{% block js %}
<script>
  const videoPlayer = document.getElementById("videoPlayer");
  const videoItems = document.querySelectorAll(".video-item");
  const nextVideoBtn = document.getElementById("nextVideoBtn");

  let currentIndex = 0;

  function loadVideo(index) {
    const selected = videoItems[index];
    videoPlayer.pause();
    videoPlayer.src = selected.dataset.videoUrl;
    videoPlayer.muted = false;

    videoItems.forEach(item => item.classList.remove("active"));
    selected.classList.add("active");

    videoItems.forEach(item => item.querySelector('.checkbox').classList.remove("checked"));
    selected.querySelector('.checkbox').classList.add("checked");

    currentIndex = index;
  }

  videoItems.forEach((item, index) => {
    item.addEventListener("click", () => {
      loadVideo(index);
    });
  });

  nextVideoBtn.addEventListener("click", () => {
    if (currentIndex + 1 < videoItems.length) {
      loadVideo(currentIndex + 1);
    }
  });

  window.addEventListener('blur', () => {
    videoPlayer.pause();
  });

  window.onload = () => {
    loadVideo(0);
  };

  window.addEventListener('beforeunload', () => {
    videoPlayer.pause();
  });
</script>
{% endblock js %}
